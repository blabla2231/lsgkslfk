<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AI App (Refactored Mobile)</title>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <style>
        /* ================================================================== */
        /* 1. –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï                                          */
        /* ================================================================== */
        :root {
            --bg-primary: #D1D9E6;
            --text-color: #444f6a;
            --accent-color: #007aff;
            --element-bg: #EAEAEA;

            /* –¢–µ–Ω–∏ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ) */
            --bubble-outer-shadow: rgba(0, 0, 0, 0.35);
            --bubble-bottom-inset: rgba(0, 0, 0, 0.25);
            --bubble-top-reflection: rgba(255, 255, 255, 0.9);
            --bubble-center-highlight: rgba(255, 255, 255, 0.7);
            --indent-shadow-top: rgba(0, 0, 0, 0.25);
            --indent-highlight-bottom: rgba(255, 255, 255, 1.0);
            --border-subtle: rgba(255, 255, 255, 0.5);
            
            --glass-glossy-bg: rgba(255, 255, 255, 0.5);
            --glass-glossy-border: rgba(255, 255, 255, 0.7);
            --glass-glossy-shadow: rgba(0, 0, 0, 0.2);
            --glass-glossy-highlight-inset: rgba(255, 255, 255, 0.8);

            /* === –ù–û–í–ê–Ø –ì–ï–û–ú–ï–¢–†–ò–Ø (CRITICAL FOR LAYOUT) === */
            --tab-bar-height: 80px;
            /* –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ —Å–Ω–∏–∑—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–æ—Å–∫–∞ Home –Ω–∞ iPhone) */
            --safe-area-bottom: var(--tg-content-safe-area-inset-bottom, 0px);
            /* –û—Ç—Å—Ç—É–ø —Ç–∞–±-–±–∞—Ä–∞ –æ—Ç —Å–∞–º–æ–≥–æ –Ω–∏–∑–∞ —ç–∫—Ä–∞–Ω–∞ (15px + –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞) */
            --floating-bar-bottom: calc(15px + var(--safe-area-bottom));
            /* –ò—Ç–æ–≥–æ–≤—ã–π –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –∑–∞–ª–µ–∑ –ø–æ–¥ —Ç–∞–±-–±–∞—Ä –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
            /* –í—ã—Å–æ—Ç–∞ –±–∞—Ä–∞ + –µ–≥–æ –æ—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∑–∞ + 20px –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ–∑–¥—É—Ö–∞ */
            --content-padding-bottom: calc(var(--tab-bar-height) + --floating-bar-bottom + 20px);
        }

        [data-theme="dark"] {
            --bg-primary: #25282E;
            --text-color: #b0b8c4;
            --accent-color: #0084ff;
            --element-bg: #30343E;
            --bubble-outer-shadow: rgba(0, 0, 0, 0.7);
            --bubble-bottom-inset: rgba(0, 0, 0, 0.5);
            --bubble-top-reflection: rgba(255, 255, 255, 0.15);
            --bubble-center-highlight: rgba(255, 255, 255, 0.1);
            --indent-shadow-top: rgba(0, 0, 0, 0.4);
            --indent-highlight-bottom: rgba(255, 255, 255, 0.1);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --glass-glossy-bg: rgba(48, 52, 62, 0.5);
            --glass-glossy-border: rgba(255, 255, 255, 0.1);
            --glass-glossy-shadow: rgba(0, 0, 0, 0.5);
            --glass-glossy-highlight-inset: rgba(255, 255, 255, 0.15);
        }

        /* ================================================================== */
        /* 2. –ö–ê–†–ö–ê–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–≠–¢–ê–õ–û–ù–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê)                         */
        /* ================================================================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-color);
            transition: background 0.3s ease, color 0.3s ease;
            /* Mobile-only setup: –∑–∞–Ω–∏–º–∞–µ–º –≤–µ—Å—å —ç–∫—Ä–∞–Ω –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–π —Å–∫—Ä–æ–ª–ª */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* –°–õ–û–ô 1: –ó–∞—â–∏—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–æ–¥ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã */
        .safe-zone-top-system {
            height: var(--tg-safe-area-inset-top);
            flex-shrink: 0;
            z-index: 1002; 
        }
        /* –°–õ–û–ô 2: –ó–∞—â–∏—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–æ–¥ —à–∞–ø–∫—É Telegram */
        .safe-zone-top-telegram {
            height: var(--tg-content-safe-area-inset-top);
            flex-shrink: 0;
            z-index: 1002;
        }

        /* –°–õ–û–ô 3: –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-layout {
            flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞–≤–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –°–õ–û–ô 4: –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .content-scroll-area {
            flex-grow: 1;
            overflow-y: auto; /* –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å */
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –¥–ª—è iOS */
            
            /* –û—Ç—Å—Ç—É–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è –∑–∞—â–∏—Ç—É –æ—Ç –≤—ã—Ä–µ–∑–æ–≤ –ø–æ –±–æ–∫–∞–º) */
            padding-top: 20px; /* –ù–µ–º–Ω–æ–≥–æ –≤–æ–∑–¥—É—Ö–∞ —Å–≤–µ—Ä—Ö—É */
            padding-left: calc(15px + var(--tg-safe-area-inset-left));
            padding-right: calc(15px + var(--tg-safe-area-inset-right));
            /* –ì–õ–ê–í–ù–û–ï: –ù–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã —Ç–∞–±-–±–∞—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∫–æ–Ω—Ü–µ */
            padding-bottom: var(--content-padding-bottom);
        }
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        .content-scroll-area::-webkit-scrollbar { width: 0; }
        

        /* ================================================================== */
        /* 3. –ü–õ–ê–í–ê–Æ–©–ò–ï –ü–ê–ù–ï–õ–ò (–ù–ò–ñ–ù–ò–ô UI)                                    */
        /* ================================================================== */
        .floating-bar {
            position: absolute;
            left: 0; right: 0;
            bottom: var(--floating-bar-bottom);
            z-index: 100;
            margin: 0 15px; /* –û—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞ */
            /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tab-bar {
            height: var(--tab-bar-height);
            max-width: 400px; /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —à–∏—Ä–∏–Ω—ã –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
            margin-left: auto; margin-right: auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            background: var(--glass-glossy-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-glossy-border);
            box-shadow: 0 10px 30px -10px var(--glass-glossy-shadow), inset 0 1px 1px var(--glass-glossy-highlight-inset);
            border-radius: 25px;
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 10px;
        }

        .chat-input-bar {
            height: var(--tab-bar-height);
            display: flex; align-items: center; gap: 10px;
            padding: 0 5px;
            opacity: 0; visibility: hidden; pointer-events: none;
            transform: translateY(20px); /* –≠—Ñ—Ñ–µ–∫—Ç –≤—ã–µ–∑–∂–∞–Ω–∏—è —Å–Ω–∏–∑—É */
        }
        .chat-input-bar.active {
            opacity: 1; visibility: visible; pointer-events: auto;
            transform: translateY(0);
        }


        /* ================================================================== */
        /* 4. –°–¢–ò–õ–ò –ö–û–ú–ü–û–ù–ï–ù–¢–û–í (–û–°–¢–ê–í–õ–ï–ù–´ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï)                      */
        /* ================================================================== */
        /* –¢–∞–±—ã */
        .tab-button { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; color: var(--text-color); background: transparent; border: none; cursor: pointer; padding: 0; transition: color 0.3s ease; }
        .tab-button .icon-wrapper { display: flex; justify-content: center; align-items: center; border-radius: 12px; width: 45px; height: 45px; background: var(--element-bg); border: 1px solid var(--border-subtle); box-shadow: 0 8px 12px -4px var(--bubble-outer-shadow), 0 -6px 10px -4px var(--bubble-top-reflection), inset 0 -3px 6px -3px var(--bubble-bottom-inset), inset 0 3px 6px -3px var(--bubble-center-highlight); transition: all 300ms cubic-bezier(0.23, 1, 0.32, 1); }
        .tab-button:active .icon-wrapper { transform: scale(0.97); box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); }
        .tab-button.active { color: var(--accent-color); }
        .tab-button.active .icon-wrapper { box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); }
        .tab-button svg { width: 22px; height: 22px; fill: var(--text-color); transition: fill 0.3s ease; }
        .tab-button.active svg { fill: var(--accent-color); }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; width: 100%; animation: fade-in 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .btn-outset, .search-input, .chat-action-btn { background: var(--element-bg); border: 1px solid var(--border-subtle); box-shadow: 0 8px 12px -4px var(--bubble-outer-shadow), 0 -6px 10px -4px var(--bubble-top-reflection), inset 0 -3px 6px -3px var(--bubble-bottom-inset), inset 0 3px 6px -3px var(--bubble-center-highlight); transition: all 300ms cubic-bezier(0.23, 1, 0.32, 1); -webkit-tap-highlight-color: transparent; cursor: pointer; border-radius: 15px; color: var(--text-color); font-family: inherit; font-size: 14px; padding: 12px 15px; }
        .btn-outset:active { transform: scale(0.97); box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); }
        .card-inset { background: var(--bg-primary); border-radius: 20px; border: 1px solid var(--border-subtle); box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); padding: 15px; }

        /* –ö–∞—Ç–∞–ª–æ–≥ */
        .catalog-search-bar { width: 100%; height: 45px; border-radius: 25px; display: flex; align-items: center; padding: 0 15px; margin-bottom: 0; }
        .catalog-search-bar input { flex-grow: 1; background: transparent; border: none; outline: none; color: var(--text-color); font-size: 16px; margin-left: 10px; }
        .catalog-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; transition: all 0.3s ease; }
        .catalog-grid.view-list { grid-template-columns: 1fr; }
        .product-card { background: transparent; border: none; box-shadow: none; border-radius: 15px; padding: 0; text-align: center; cursor: pointer; isolation: isolate; }
        .product-card .img-container { border-radius: 15px; padding: 10px; margin-bottom: 10px; background: var(--bg-primary); border: 1px solid var(--border-subtle); box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); position: relative; }
        .product-card img { width: 100%; height: 100px; object-fit: cover; border-radius: 10px; }
        .product-rating { position: absolute; top: 18px; right: 18px; width: 30px; height: 30px; border-radius: 50%; background-color: #27ae60; color: white; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10; }
        .product-card .btn-outset { width: 100%; padding: 8px 5px; border-radius: 10px; font-weight: 600; font-size: 13px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { font-size: 12px; opacity: 0.7; margin-top: 5px; }
        .filter-buttons {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -ms-overflow-style: none; scrollbar-width: none;

            /* –ü–£–ó–´–†–¨ –í–û–ó–î–£–•–ê: */
            padding: 15px 5px; /* 10px —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É (—á—Ç–æ–±—ã —Ç–µ–Ω–∏ –≤–ª–µ–∑–ª–∏), 5px –ø–æ –±–æ–∫–∞–º */
            
            margin: 0; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–Ω–µ—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ –Ω–µ—Ç */
        }     
        .filter-buttons::-webkit-scrollbar { display: none; }
        .filter-buttons .btn-outset { padding: 10px 18px; border-radius: 25px; font-size: 14px; white-space: nowrap; font-weight: bold; }
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .catalog-search-bar, .primary-filters, .action-filters { max-height: 200px; overflow: hidden; will-change: max-height, opacity; transition: all 300ms ease; }
        .primary-filters { transition-delay: 50ms; } .action-filters { transition-delay: 100ms; }
        .catalog-search-bar.hidden, .primary-filters.hidden, .action-filters.hidden { max-height: 0; opacity: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; pointer-events: none; }
        .primary-filters {
            /* –°–µ–π—á–∞—Å –º–µ–∂–¥—É –ø–æ–ª–∫–∞–º–∏ –ø—É–∑—ã—Ä—å –≤–æ–∑–¥—É—Ö–∞: 15px (—Å–Ω–∏–∑—É –ø–µ—Ä–≤–æ–π) + 15px (—Å–≤–µ—Ä—Ö—É –≤—Ç–æ—Ä–æ–π) = 30px.
            –ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Å—Ç–∞–ª–æ—Å—å 10px.
            –ó–Ω–∞—á–∏—Ç, –Ω–∞–¥–æ —É–±—Ä–∞—Ç—å 20px.
            */
            margin-bottom: -20px !important; 
            
            position: relative; 
            z-index: 2; /* –ß—Ç–æ–±—ã –µ–≥–æ —Ç–µ–Ω–∏ –±—ã–ª–∏ –ø–æ–≤–µ—Ä—Ö –Ω–∏–∂–Ω–µ–≥–æ —Ä—è–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ—Å–µ–∫—É—Ç—Å—è */
        }

        /* –û—Ç—Å—Ç—É–ø –æ—Ç –í—Ç–æ—Ä–æ–≥–æ —Ä—è–¥–∞ –¥–æ –¢–æ–≤–∞—Ä–æ–≤ */
        /* –í—Ç–æ—Ä–æ–π —Ä—è–¥ –∏–º–µ–µ—Ç padding-bottom: 20px. */
        /* –ù–∞–º –¥–æ —Ç–æ–≤–∞—Ä–æ–≤ –Ω—É–∂–Ω–æ, —Å–∫–∞–∂–µ–º, 15px. */
        .action-filters {
            margin-bottom: -5px !important; /* 20px (–≤–æ–∑–¥—É—Ö) - 5px (margin) = 15px (–∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—Å—Ç—É–ø) */
            position: relative;
            z-index: 1;
        }
        /* –ß–∞—Ç */
        .chat-container { display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px; }
        .chat-message { display: flex; }
        .chat-bubble { max-width: 80%; border-radius: 18px; line-height: 1.4; padding: 12px 15px; word-wrap: break-word; }
        .ai-message { justify-content: flex-start; }
        .ai-message .chat-bubble { background: var(--bg-primary); border: 1px solid var(--border-subtle); box-shadow: inset 0 6px 10px 0 var(--indent-shadow-top), inset 0 -4px 8px 0 var(--indent-highlight-bottom); border-bottom-left-radius: 2px; }
        .user-message { justify-content: flex-end; }
        .user-message .chat-bubble { background: var(--element-bg); border: 1px solid var(--border-subtle); box-shadow: 0 8px 12px -4px var(--bubble-outer-shadow), 0 -6px 10px -4px var(--bubble-top-reflection), inset 0 -3px 6px -3px var(--bubble-bottom-inset), inset 0 3px 6px -3px var(--bubble-center-highlight); border-bottom-right-radius: 2px; }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 15px; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background: var(--text-color); opacity: 0.5; animation: typing-bounce 1.4s infinite ease-in-out; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
        .chat-action-btn { padding: 8px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 4px 8px -2px var(--bubble-outer-shadow); cursor: pointer; }
        .chat-action-btn.added { background: #27ae60; color: white; pointer-events: none; }
        .chat-input-field { flex-grow: 1; height: 50px; border-radius: 25px; padding: 0 20px; }
        .chat-input-field input { width: 100%; height: 100%; background: none; border: none; outline: none; color: var(--text-color); font-size: 16px; }
        .chat-action-btn-small { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .chat-action-btn-small svg { fill: var(--text-color); width: 24px; height: 24px; }

        /* –°–ø–∏—Å–∫–∏ */
        .list-group { margin-bottom: 25px; }
        .list-group-header { display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 700; color: var(--text-color); margin-bottom: 10px; cursor: pointer; transition: opacity 0.3s ease; }
        .list-group-header:hover { opacity: 0.7; }
        .list-item { display: flex; justify-content: space-between; align-items: center; border-radius: 15px; padding: 12px 15px; margin-top: 5px; transition: opacity 0.3s ease; cursor: pointer; }
        .item-name { flex-grow: 1; font-size: 16px; font-weight: 500; }
        .list-item.done .item-name { text-decoration: line-through; opacity: 0.6; }
        .checkbox-switch { position: relative; width: 50px; height: 26px; border-radius: 13px; padding: 3px; cursor: pointer; transition: all 0.3s ease; }
        .checkbox-slider { width: 20px; height: 20px; border-radius: 50%; background: var(--bg-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: transform 0.3s ease; }
        .list-item.done .checkbox-slider { transform: translateX(24px); background: #27ae60; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-section { margin-bottom: 30px; }
        .profile-section h3 { font-size: 18px; font-weight: 600; opacity: 0.8; margin-bottom: 15px; }
        .profile-card { padding: 20px; text-align: center; margin-bottom: 15px; }
        .profile-card h4 { margin: 10px 0 0; }
        .profile-card p { font-size: 14px; opacity: 0.7; }
        .setting-button { width: 100%; padding: 15px; border-radius: 15px; text-align: left; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 500; cursor: pointer; background: var(--element-bg); border: none; box-shadow: 0 8px 12px -4px var(--bubble-outer-shadow), 0 -6px 10px -4px var(--bubble-top-reflection), inset 0 -3px 6px -3px var(--bubble-bottom-inset), inset 0 3px 6px -3px var(--bubble-center-highlight); transition: all 300ms cubic-bezier(0.23, 1, 0.32, 1); color: var(--text-color); font-family: inherit; }
        .setting-button span { opacity: 0.7; font-size: 14px; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 998; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-primary); border-radius: 20px; padding: 20px; width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s ease; }
        #modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; }
        .modal-content .btn-outset { width: 100%; margin-top: 10px; padding: 12px; font-size: 16px; transition: background 0.3s ease; }
        .modal-content .btn-outset.selected { background: var(--accent-color); color: white; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast { visibility: hidden; opacity: 0; position: fixed; left: 50%; bottom: 120px; transform: translate(-50%, 0); min-width: 200px; background: var(--element-bg); color: var(--text-color); text-align: center; border-radius: 20px; padding: 15px 20px; z-index: 999; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-size: 14px; font-weight: 600; transition: opacity 0.3s, visibility 0.3s, transform 0.3s ease-out; }
        .toast.show { visibility: visible; opacity: 1; transform: translate(-50%, -20px); }
        
        .skeleton { background: linear-gradient(90deg, var(--element-bg) 25%, var(--bg-primary) 50%, var(--element-bg) 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s ease-in-out infinite; border-radius: 10px; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

    <div class="safe-zone-top-system"></div>
    <div class="safe-zone-top-telegram"></div>

    <div class="app-layout">
        
        <div class="content-scroll-area" id="main-scroll">

            <div id="catalog-screen" class="screen active">
                <div class="card-inset catalog-search-bar">
                    <svg style="fill:var(--text-color); opacity:0.6;" viewBox="0 0 24 24" width="20" height="20"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" id="catalog-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É...">
                </div>
                <div class="filter-buttons primary-filters" style="margin-bottom: 10px;">
                    <button class="btn-outset" onclick="Nav.to('all-products-screen')">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
                    <button class="btn-outset" onclick="Nav.to('categories-screen')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                    <button class="btn-outset" id="view-toggle" style="padding: 10px; border-radius: 50%; width: 45px; height: 45px;"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="var(--text-color)" d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg></button>
                </div>
                <div class="filter-buttons action-filters">
                    <button class="btn-outset" id="sort-btn" onclick="ModalOrchestrator.show('sort')">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn-outset" id="filter-btn" onclick="ModalOrchestrator.show('filter')">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                <div class="catalog-grid" id="catalog-grid">
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                        <div class="img-container"><img src="https://placehold.co/150x100/27ae60/FFF?text=–ô–æ–≥—É—Ä—Ç" alt="–ô–æ–≥—É—Ä—Ç –ß—É–¥–æ" /><div class="product-rating" style="background-color:#27ae60;">8.7</div></div><button class="btn-outset">–ô–æ–≥—É—Ä—Ç –ß—É–¥–æ –í–∏—à–Ω—è</button><p class="product-price">89.90 —Ä—É–±.</p>
                    </div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                        <div class="img-container"><img src="https://placehold.co/150x100/f39c12/FFF?text=–•–ª–µ–±—Ü—ã" alt="–•–ª–µ–±—Ü—ã" /><div class="product-rating" style="background-color:#f39c12;">4.2</div></div><button class="btn-outset">–•–ª–µ–±—Ü—ã Fit Start</button><p class="product-price">125.00 —Ä—É–±.</p>
                    </div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                        <div class="img-container"><img src="https://placehold.co/150x100/c0392b/FFF?text=–ü—Ä–æ–¥—É–∫—Ç" alt="–ü—Ä–æ–¥—É–∫—Ç" /><div class="product-rating" style="background-color:#c0392b;">2.1</div></div><button class="btn-outset">–ö—Ä—É–∞—Å—Å–∞–Ω –û–±—ã—á–Ω—ã–π</button><p class="product-price">45.50 —Ä—É–±.</p>
                    </div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)"><div class="img-container"><img src="https://placehold.co/150x100/555/FFF?text=–ú—è—Å–æ" alt="–ú—è—Å–æ" /><div class="product-rating" style="background-color:#27ae60;">9.1</div></div><button class="btn-outset">–§–∞—Ä—à –ì–æ–≤—è–∂–∏–π</button><p class="product-price">350.00 —Ä—É–±.</p></div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)"><div class="img-container"><img src="https://placehold.co/150x100/555/FFF?text=–ß–∞–π" alt="–ß–∞–π" /><div class="product-rating" style="background-color:#27ae60;">7.8</div></div><button class="btn-outset">–ß–∞–π –ó–µ–ª–µ–Ω—ã–π</button><p class="product-price">220.00 —Ä—É–±.</p></div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)"><div class="img-container"><img src="https://placehold.co/150x100/555/FFF?text=–ù–∞–ø–∏—Ç–æ–∫" alt="–ù–∞–ø–∏—Ç–æ–∫" /><div class="product-rating" style="background-color:#f39c12;">5.5</div></div><button class="btn-outset">–ì–∞–∑–∏—Ä–æ–≤–∫–∞ '–°–ª–∞–¥–æ—Å—Ç—å'</button><p class="product-price">70.00 —Ä—É–±.</p></div>
                    <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/8e44ad/FFF?text=–°–º—É–∑–∏" alt="–°–º—É–∑–∏" />
                        <div class="product-rating" style="background-color:#8e44ad;">9.5</div>
                    </div>
                    <button class="btn-outset">–°–º—É–∑–∏ –Ø–≥–æ–¥–Ω—ã–π –ú–∏–∫—Å</button>
                    <p class="product-price">180.00 —Ä—É–±.</p>
                </div>
                <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/2980b9/FFF?text=–í–æ–¥–∞" alt="–í–æ–¥–∞" />
                        <div class="product-rating" style="background-color:#2980b9;">8.0</div>
                    </div>
                    <button class="btn-outset">–ú–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è –í–æ–¥–∞</button>
                    <p class="product-price">45.00 —Ä—É–±.</p>
                </div>
                <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/d35400/FFF?text=–û—Ä–µ—Ö–∏" alt="–û—Ä–µ—Ö–∏" />
                        <div class="product-rating" style="background-color:#27ae60;">9.8</div>
                    </div>
                    <button class="btn-outset">–ú–∏–Ω–¥–∞–ª—å –ñ–∞—Ä–µ–Ω—ã–π</button>
                    <p class="product-price">320.00 —Ä—É–±.</p>
                </div>
                <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/2c3e50/FFF?text=–ö–æ—Ñ–µ" alt="–ö–æ—Ñ–µ" />
                        <div class="product-rating" style="background-color:#f39c12;">7.5</div>
                    </div>
                    <button class="btn-outset">–•–æ–ª–æ–¥–Ω—ã–π –ö–æ—Ñ–µ</button>
                    <p class="product-price">140.00 —Ä—É–±.</p>
                </div>
                <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/c0392b/FFF?text=–®–æ–∫–æ–ª–∞–¥" alt="–®–æ–∫–æ–ª–∞–¥" />
                        <div class="product-rating" style="background-color:#c0392b;">3.5</div>
                    </div>
                    <button class="btn-outset">–ú–æ–ª–æ—á–Ω—ã–π –®–æ–∫–æ–ª–∞–¥</button>
                    <p class="product-price">95.00 —Ä—É–±.</p>
                </div>
                <div class="product-card" onclick="ProductDetailsScreen.show(this)">
                    <div class="img-container">
                        <img src="https://placehold.co/150x100/27ae60/FFF?text=–°–∞–ª–∞—Ç" alt="–°–∞–ª–∞—Ç" />
                        <div class="product-rating" style="background-color:#27ae60;">9.9</div>
                    </div>
                    <button class="btn-outset">–°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å BIO</button>
                    <p class="product-price">280.00 —Ä—É–±.</p>
                </div>
                </div>
            </div>

            <div id="chat-screen" class="screen"> 
                 <div class="chat-container" id="chat-messages">
                    <div class="chat-message ai-message"><div class="chat-bubble card-inset">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∑–¥–æ—Ä–æ–≤—ã–º –ø–æ–∫—É–ø–∫–∞–º. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div></div>
                </div>
            </div>

            <div id="list-screen" class="screen">
                <div class="list-group">
                    <div class="list-group-header"><span>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ (–°–µ–≥–æ–¥–Ω—è)</span></div>
                    <div class="list-container">
                        <div class="list-item card-inset" onclick="ShoppingListModule.toggleItem(this)"><span class="item-name">–ô–æ–≥—É—Ä—Ç Activia Natural</span><div class="checkbox-switch btn-outset"><div class="checkbox-slider"></div></div></div>
                        <div class="list-item card-inset done" onclick="ShoppingListModule.toggleItem(this)"><span class="item-name">–•–ª–µ–±—Ü—ã Fit Start (–ö—É–ø–ª–µ–Ω–æ)</span><div class="checkbox-switch btn-outset"><div class="checkbox-slider"></div></div></div>
                        <div class="list-item card-inset" onclick="ShoppingListModule.toggleItem(this)"><span class="item-name">–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ</span><div class="checkbox-switch btn-outset"><div class="checkbox-slider"></div></div></div>
                    </div>
                </div>
                <div class="list-group">
                    <div class="list-group-header" onclick="ShoppingListModule.toggleHistory(this)">
                        <span>–ò—Å—Ç–æ—Ä–∏—è –ü–æ–∫—É–ø–æ–∫</span>
                        <svg class="history-arrow" viewBox="0 0 24 24" width="20" height="20" style="fill:var(--text-color); transition: transform 0.3s ease;"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
                    </div>
                    <div class="list-container history-items" style="display:none; opacity: 0.5;">
                         <p style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">8 –ù–æ—è–±—Ä—è 2025</p>
                         <div class="list-item card-inset done"><span class="item-name">–ú–æ–ª–æ–∫–æ</span><div class="checkbox-switch btn-outset"><div class="checkbox-slider"></div></div></div>
                    </div>
                </div>
            </div>

            <div id="details-screen" class="screen"></div>

            <div id="profile-screen" class="screen">
                <div class="profile-section">
                    <div class="card-inset profile-card">
                        <img src="https://placehold.co/80x80/007aff/FFFFFF?text=P" style="border-radius:50%; margin-bottom:10px;" alt="–ü—Ä–æ—Ñ–∏–ª—å" />
                        <h4 style="color:var(--accent-color);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h4><p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                    </div>
                </div>
                <div class="profile-section">
                    <h3>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –ó–¥–æ—Ä–æ–≤—å–µ</h3>
                    <button class="setting-button" onclick="Nav.to('store-screen')">–ú–∞–≥–∞–∑–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é <span>–ú–∞–≥–Ω–∏—Ç ></span></button>
                    <button class="setting-button" onclick="Nav.to('allergy-screen')">–ê–ª–ª–µ—Ä–≥–∏–∏ <span>–ú–æ–ª–æ–∫–æ, –ì–ª—é—Ç–µ–Ω ></span></button>
                </div>
                <div class="profile-section">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ UI</h3>
                    <button id="theme-toggle-profile" class="setting-button">
                        <span style="display: flex; align-items: center; gap: 8px;"><svg id="theme-icon" width="20" height="20" viewBox="0 0 24 24"><path fill="var(--text-color)" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg> –°–≤–µ—Ç–ª–∞—è / –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <span id="theme-label">–¢–µ–∫—É—â–∞—è: –°–≤–µ—Ç–ª–∞—è</span>
                    </button>
                </div>
            </div>

            <div id="all-products-screen" class="screen"><h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</h3><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;"><div class="skeleton" style="height: 200px;"></div><div class="skeleton" style="height: 200px;"></div></div></div>
            <div id="categories-screen" class="screen"><h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3><button class="setting-button" onclick="CatalogModule.filterByCategory('dairy')">üßÄ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</button><button class="setting-button" onclick="CatalogModule.filterByCategory('meat')">ü•© –ú—è—Å–æ –∏ –ü—Ç–∏—Ü–∞</button></div>
            <div id="store-screen" class="screen"><h3>–ú–∞–≥–∞–∑–∏–Ω</h3><button class="setting-button selected" onclick="ProfileModule.selectStore(this)">–ú–∞–≥–Ω–∏—Ç <span>‚úì –í—ã–±—Ä–∞–Ω–æ</span></button><button class="setting-button" onclick="ProfileModule.selectStore(this)">–ü—è—Ç–µ—Ä–æ—á–∫–∞ <span>></span></button></div>
            <div id="allergy-screen" class="screen"><h3>–ê–ª–ª–µ—Ä–≥–∏–∏</h3><div class="list-item card-inset" onclick="ProfileModule.toggleAllergy(this)"><span class="item-name">–ú–æ–ª–æ–∫–æ</span><div class="checkbox-switch btn-outset done"><div class="checkbox-slider"></div></div></div></div>

        </div> <div id="chat-input-area" class="floating-bar chat-input-bar">
            <button class="chat-action-btn-small btn-outset"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 2.76 2.24 5 5 5s5-2.24 5-5V6h-1.5z"/></svg></button>
            <div class="chat-input-field card-inset"><input type="text" id="chat-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ò–ò..."></div>
            <button class="chat-action-btn-small btn-outset" onclick="ChatModule.sendMessage()"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>

        <div id="main-tab-bar" class="floating-bar tab-bar">
            <button class="tab-button active" data-target="catalog-screen"><div class="icon-wrapper"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M12 10a5 5 0 0 1 5 5v7h-2v-7a3 3 0 0 0-3-3 3 3 0 0 0-3 3v7H7v-7a5 5 0 0 1 5-5zM12 1L8 5h8zM4 17h2v5H4zM18 17h2v5h-2z"/></svg></div><span>–ö–∞—Ç–∞–ª–æ–≥</span></button>
            <button class="tab-button" data-target="chat-screen"><div class="icon-wrapper"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg></div><span>AI –ß–∞—Ç</span></button>
            <button class="tab-button" data-target="list-screen"><div class="icon-wrapper"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M14 10H6v2h8v-2zm0-4H6v2h8V6zm1.5 10c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM21 6H11V4h10v2zm0 4H11V8h10v2zm0 4H11v-2h10v2zm-2 4h-8v-2h8v2z"/></svg></div><span>–°–ø–∏—Å–æ–∫</span></button>
            <button class="tab-button" data-target="profile-screen"><div class="icon-wrapper"><svg viewBox="0 0 24 24"><path fill="var(--text-color)" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        </div>
    </div>

    <div id="modal-overlay" onclick="ModalOrchestrator.hide()"><div class="modal-content" onclick="event.stopPropagation()"><h3 id="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h3><div id="modal-body"></div><button class="btn-outset" style="margin-top: 20px; background: var(--accent-color); color: white;" onclick="ModalOrchestrator.apply()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div></div>
    <div id="toast-notification" class="toast"></div>

    <script>
        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ===
        const tg = window.Telegram.WebApp;
        tg.ready();
        if (tg.requestFullscreen) tg.requestFullscreen();
        // –ö—Ä–∞—Å–∏–º —à–∞–ø–∫—É –≤ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ (—Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è Fullscreen)
        if (tg.setHeaderColor) tg.setHeaderColor(getComputedStyle(document.body).getPropertyValue('--bg-primary').trim());

        const CONFIG = {
            ANIMATIONS: { TYPING_DURATION: 1500, TOAST_DURATION: 2000 },
            SCREENS: { CATALOG: 'catalog-screen', CHAT: 'chat-screen', LIST: 'list-screen', PROFILE: 'profile-screen', DETAILS: 'details-screen' }
        };
        let AppState = { currentScreen: CONFIG.SCREENS.CATALOG, selectedFilters: [], selectedSort: null };

        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        const Brick = {
            addClass: (el, className) => el?.classList.add(className),
            removeClass: (el, className) => el?.classList.remove(className),
            toggleClass: (el, className) => el?.classList.toggle(className),
            haptic: (type = 'light') => tg.HapticFeedback.impactOccurred(type),
            showToast: (message) => {
                const toast = document.getElementById('toast-notification');
                toast.textContent = message;
                Brick.addClass(toast, 'show');
                setTimeout(() => Brick.removeClass(toast, 'show'), CONFIG.ANIMATIONS.TOAST_DURATION);
            }
        };

        const DOM = {
            getScreenById: (id) => document.getElementById(id),
            getAllScreens: () => document.querySelectorAll('.screen'),
            getTabButtons: () => document.querySelectorAll('.tab-button'),
            getScrollContainer: () => document.getElementById('main-scroll'),
            getTabBar: () => document.getElementById('main-tab-bar'),
            getChatInputBar: () => document.getElementById('chat-input-area'),
            getRoot: () => document.documentElement,
        };

        // === –ù–ê–í–ò–ì–ê–¶–ò–Ø (–°—Ç–µ–∫ –ò—Å—Ç–æ—Ä–∏–∏) ===
        const Nav = {
            historyStack: [],
            mainScreens: [CONFIG.SCREENS.CATALOG, CONFIG.SCREENS.LIST, CONFIG.SCREENS.PROFILE],
            currentScreenId: CONFIG.SCREENS.CATALOG,

            to: (targetId) => {
                if (targetId === Nav.currentScreenId) return;
                Brick.haptic('light');

                const isMain = Nav.mainScreens.includes(targetId);
                if (isMain) {
                    Nav.historyStack = []; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –≥–ª–∞–≤–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö
                    tg.BackButton.hide();
                } else {
                    Nav.historyStack.push(Nav.currentScreenId); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏
                    tg.BackButton.show();
                }

                Nav.switchScreen(targetId);
                Nav.updateFloatingBars(targetId);
            },

            back: () => {
                if (Nav.historyStack.length > 0) {
                    const prevScreenId = Nav.historyStack.pop();
                    Brick.haptic('light');
                    Nav.switchScreen(prevScreenId);
                    Nav.updateFloatingBars(prevScreenId);
                    
                    if (Nav.historyStack.length === 0) tg.BackButton.hide();
                } else {
                    Nav.to(CONFIG.SCREENS.CATALOG); // –§–æ–ª–±—ç–∫ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥
                }
            },

            switchScreen: (targetId) => {
                DOM.getAllScreens().forEach(screen => Brick.removeClass(screen, 'active'));
                Brick.addClass(DOM.getScreenById(targetId), 'active');
                
                DOM.getTabButtons().forEach(btn => Brick.removeClass(btn, 'active'));
                const activeBtn = document.querySelector(`.tab-button[data-target="${targetId}"]`);
                if (activeBtn) Brick.addClass(activeBtn, 'active');

                Nav.currentScreenId = targetId;
                DOM.getScrollContainer().scrollTop = 0; // –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö
            },

            updateFloatingBars: (screenId) => {
                const isChat = screenId === CONFIG.SCREENS.CHAT;
                const isMain = Nav.mainScreens.includes(screenId);

                const tabBar = DOM.getTabBar();
                const chatInput = DOM.getChatInputBar();

                // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –¢–∞–±-–±–∞—Ä–∞: –≤–∏–¥–µ–Ω –Ω–∞ –≥–ª–∞–≤–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö, –ö–†–û–ú–ï —á–∞—Ç–∞
                if (isMain && !isChat) {
                    tabBar.style.visibility = 'visible';
                    tabBar.style.opacity = '1';
                    tabBar.style.pointerEvents = 'auto';
                } else {
                    tabBar.style.visibility = 'hidden';
                    tabBar.style.opacity = '0';
                    tabBar.style.pointerEvents = 'none';
                }

                // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞ —á–∞—Ç–∞
                if (isChat) {
                    Brick.addClass(chatInput, 'active');
                } else {
                    Brick.removeClass(chatInput, 'active');
                }
            }
        };

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        tg.BackButton.onClick(Nav.back);

        // === –ú–û–î–£–õ–ò (–û–°–¢–ê–í–õ–ï–ù–´ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –õ–û–ì–ò–ö–ï) ===
        const ModalOrchestrator = { show: (type) => { Brick.haptic('medium'); Brick.addClass(document.getElementById('modal-overlay'), 'active'); }, hide: () => Brick.removeClass(document.getElementById('modal-overlay'), 'active'), apply: () => { ModalOrchestrator.hide(); Brick.showToast('–ü—Ä–∏–º–µ–Ω–µ–Ω–æ!'); } };
        const CatalogModule = { init: () => { document.getElementById('view-toggle').addEventListener('click', () => { document.getElementById('catalog-grid').classList.toggle('view-list'); Brick.haptic('light'); }); }, filterByCategory: (cat) => { Brick.showToast('–§–∏–ª—å—Ç—Ä: ' + cat); Nav.to(CONFIG.SCREENS.CATALOG); } };
        const ChatModule = { init: () => { document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key==='Enter') ChatModule.sendMessage(); }); }, sendMessage: () => { const i=document.getElementById('chat-input'); if(!i.value.trim())return; const c=document.getElementById('chat-messages'); c.innerHTML+=`<div class="chat-message user-message"><div class="chat-bubble btn-outset">${i.value}</div></div>`; i.value=''; const sc=DOM.getScrollContainer(); sc.scrollTop=sc.scrollHeight; setTimeout(()=>{c.innerHTML+=`<div class="chat-message ai-message"><div class="chat-bubble card-inset">–û—Ç–≤–µ—Ç –ò–ò...</div></div>`; sc.scrollTop=sc.scrollHeight;}, 1000); } };
        const ProfileModule = { init: () => { document.getElementById('theme-toggle-profile').addEventListener('click', ProfileModule.toggleTheme); ProfileModule.updateThemeDisplay(); }, toggleTheme: () => { const h=DOM.getRoot(); const n=h.getAttribute('data-theme')==='light'?'dark':'light'; h.setAttribute('data-theme',n); TG_MOCK.WebApp.colorScheme = n; ProfileModule.updateThemeDisplay(); Brick.showToast('–¢–µ–º–∞: '+n); }, updateThemeDisplay: () => { const t = DOM.getRoot().getAttribute('data-theme'); document.getElementById('theme-label').textContent = '–¢–µ–∫—É—â–∞—è: ' + (t==='light'?'–°–≤–µ—Ç–ª–∞—è':'–¢–µ–º–Ω–∞—è'); }, selectStore: (b) => { document.querySelectorAll('#store-screen .setting-button').forEach(bn=>Brick.removeClass(bn,'selected')); Brick.addClass(b,'selected'); Brick.showToast('–ú–∞–≥–∞–∑–∏–Ω –≤—ã–±—Ä–∞–Ω'); }, toggleAllergy: (el) => { Brick.haptic('light'); Brick.toggleClass(el.querySelector('.checkbox-switch'), 'done'); } };
        const ProductDetailsScreen = { show: (c) => { document.getElementById('details-screen').innerHTML=`<div class="card-inset" style="padding:20px; margin-bottom:20px;"><div class="img-container" style="margin-bottom:15px;"><img src="${c.querySelector('img').src}" style="width:100%; border-radius:15px;"></div><h3>${c.querySelector('.btn-outset').textContent}</h3><p style="opacity:0.7; margin-top:10px;">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, —Å–æ—Å—Ç–∞–≤ –∏ –ö–ë–ñ–£...</p><button class="btn-outset" style="width:100%; margin-top:20px; background:var(--accent-color); color:white;">–í –∫–æ—Ä–∑–∏–Ω—É</button></div>`; Nav.to(CONFIG.SCREENS.DETAILS); } };
        const ShoppingListModule = { toggleItem: (el) => { Brick.haptic('light'); Brick.toggleClass(el, 'done'); }, toggleHistory: (h) => { Brick.haptic('light'); const c=h.nextElementSibling; c.style.display=c.style.display==='none'?'block':'none'; h.querySelector('.history-arrow').style.transform=c.style.display==='block'?'rotate(180deg)':'rotate(0deg)'; } };

        // === –ó–ê–ü–£–°–ö ===
        document.addEventListener('DOMContentLoaded', () => {
            CatalogModule.init(); ChatModule.init(); ProfileModule.init();
            DOM.getTabButtons().forEach(btn => btn.addEventListener('click', (e) => Nav.to(e.currentTarget.dataset.target)));
            document.getElementById('modal-overlay').addEventListener('click', function(e) { if (e.target === this) ModalOrchestrator.hide(); });
            Nav.to(CONFIG.SCREENS.CATALOG); // –°—Ç–∞—Ä—Ç —Å –∫–∞—Ç–∞–ª–æ–≥–∞
        });
    </script>
</body>
</html>
